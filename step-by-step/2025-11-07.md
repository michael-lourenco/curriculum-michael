# 2025-11-07 – Publicação TikTok

## Etapas executadas
- Atualizei `src/app/tiktok/api/videos/publish/route.ts` para incluir metadados obrigatórios em `source_info`, garantindo que o init da publicação aceite vídeos enviados diretamente (formato, tamanho, padrão de upload, chunk único).
- Ajustei `src/app/tiktok/publish/page.tsx` e `src/app/tiktok/validate/page.tsx` aplicando classes `bg-white`, `text-gray-900` e `placeholder:text-gray-500` nos campos de formulário para restaurar o contraste do texto.
- Substituí a URL padrão de demonstração em `src/app/tiktok/publish/page.tsx` por um vídeo curto (≈7s) hospedado no domínio da MDN, garantindo testes rápidos dentro do limite de 15 segundos.
- Ajustei `src/app/tiktok/api/videos/publish/route.ts` para alinhar `source_info` com os campos aceitos pela API (`source`, `video_size`, `video_type`), evitando rejeição por parâmetros inválidos.
- Desativei o prefetch automático dos cards em `src/app/tiktok/home/page.tsx` para impedir que o Next.js antecipe o carregamento de páginas que dependem do cookie `tiktok_access_token`, eliminando os 401 durante prefetch.
- Ampliei `src/app/tiktok/api/videos/publish/route.ts` para aceitar uploads via `multipart/form-data`, lendo arquivos locais ou URLs e normalizando metadados e booleanos.
- Atualizei `src/app/tiktok/publish/page.tsx` para construir `FormData`, permitir seleção de arquivos locais e enviar credenciais automaticamente, priorizando o arquivo quando presente.
- Incluí `chunk_size` e `total_chunk_count` no `source_info` dentro de `src/app/tiktok/api/videos/publish/route.ts`, alinhando o payload ao exemplo oficial de upload direto da documentação da Content Posting API.
- Ajustei `src/app/tiktok/api/videos/publish/route.ts` para priorizar o fluxo de rascunho (`post.draft`), mantendo o upload multipart e adicionando fallback para publicação direta somente quando solicitado.
- Atualizei `src/app/tiktok/publish/page.tsx` para construir `FormData`, permitir seleção de arquivos locais e enviar credenciais automaticamente, priorizando o arquivo quando presente.
- Atualizei `src/app/tiktok/publish/page.tsx` novamente para informar claramente que o envio cria rascunhos, anexar `mode=draft` e exibir mensagens de sucesso orientando o usuário a finalizar no aplicativo.
- Incluí o cálculo e envio de `video_hash` (MD5) em `src/app/tiktok/api/videos/publish/route.ts`, reforçando a compatibilidade com os requisitos de init da TikTok Content Posting API.

## Função dos arquivos impactados
- `src/app/tiktok/api/videos/publish/route.ts`: rota API que orquestra o fluxo de publicação, agora padronizando rascunhos (download ou upload do vídeo, init via `post.draft`, upload e tentativa de consulta de status).
- `src/app/tiktok/publish/page.tsx`: página client-side que permite configurar metadados, enviar rascunhos ao TikTok e consultar status, informando o processo manual de finalização.
- `src/app/tiktok/validate/page.tsx`: página client-side utilizada para validar manualmente tokens de acesso e inspecionar escopos e campos disponíveis.

## Pendências / próximos passos
- Validar se há outros formulários no projeto com o mesmo problema de contraste e aplicar o mesmo ajuste caso necessário.
